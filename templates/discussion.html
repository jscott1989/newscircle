{% extends "base.html" %}
{% load staticfiles %}
{% load sekizai_tags %}
{% load markdown_deux_tags %}

{% block title %}{{topic.title}}{% endblock %}

{% block content %}
    <div class="row">
        <div class="small-8 columns">
            {% if topic.url %}
                <h1 style="display: inline-block"><a target="_BLANK" href="{{topic.url}}">{{topic.title}}</a></h1> {{topic.logo|safe}}
            {% else %}
                <h1>{{topic.title}}</h1>
            {% endif %}
            {% if request.user.is_superuser %}
                {% if topic.pinned %}
                    <form method="POST" action="{% url "unpin_topic" topic.pk %}">
                        {% csrf_token %}
                        <button type="submit">Unpin</button>
                    </form>
                {% else %}
                    <form method="POST" action="{% url "pin_topic" topic.pk %}">
                        {% csrf_token %}
                        <button type="submit">Pin</button>
                    </form>
                {% endif %}
            {% endif %}
            <p>{{topic.description|markdown}}</p>
            {{topic.embed_html|safe}}

            <div id="discussion">

            </div>
        </div>
        <div class="small-4 columns" id="sidebar">
            <br />
            <a class="button" href="#" id="go_back">Back to list</a>
            <a class="button" href="#" id="reply_link">Reply</a>

            <div class="users">{{total_users}} total users</div>
            <div class="users">{{active_users}} current user{{active_users|pluralize}}</div>
            <h2>UK News</h2>

            <p>This is a forum for discussing news topics. This will primarily concern the United Kingdom but may occasionally have topics which are more broad.</p>

            <p>The newscircle system aims to promote a wider range of viewpoints than present in other media by analysing contribution positions using voting behaviour.</p>

            <p>This is part of study #15776 at the University of Southampton. <a href="{% url "info" %}">Click here for more information</a>.</p>
        </div>
    </div>

    {% addtoblock "js" %}
        <script>
            var DISCUSSION_ID = {{topic.id}};
            var DISCUSSION_LOCKED = false;
            var USER_AUTHENTICATED = false;
            var CURRENT_USER_ID = 0;
            {% if topic.locked %}
                DISCUSSION_LOCKED = true;
            {% endif %}
            {% if request.user.is_authenticated %}
                USER_AUTHENTICATED = true;
                var CURRENT_USER_ID = {{topic_user.id}};
            {% endif %}

        </script>
        <!-- Libraries -->
        <script src="{% static "jquery/dist/jquery.min.js"%}"></script>
        <script src="{% static "jquery.cookie/jquery.cookie.js"%}"></script>
        <script src="{% static "jquery.scrollTo/jquery.scrollTo.min.js"%}"></script>
        <script src="{% static "moment/moment.js"%}"></script>
        <script src="{% static "underscore/underscore-min.js"%}"></script>
        <script src="{% static "react/react.min.js"%}"></script>
        <script src="{% static "backbone/backbone.js"%}"></script>
        <script src="{% static "backbone-computed-properties/dist/backbone-computed.min.js"%}"></script>
        <script src="{% static "foundation/js/foundation.min.js"%}"></script>

        <!-- External code -->
        <script src="{% static "js/lib/BackboneMixin.js"%}"></script>

        <!-- Application code -->
        <script>
            var STARTING_COMMENTS = {{comments|safe}};
            var STARTING_USERS = {{users|safe}};
            var STARTING_GROUPS = {{groups|safe}};


            var csrftoken = $.cookie('csrftoken');
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }
            function sameOrigin(url) {
                // test that a given url is a same-origin URL
                // url could be relative or scheme relative or absolute
                var host = document.location.host; // host + port
                var protocol = document.location.protocol;
                var sr_origin = '//' + host;
                var origin = protocol + sr_origin;
                // Allow absolute or scheme relative URLs to same origin
                return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                    (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
                    // or any other URL that isn't scheme relative or absolute i.e relative.
                    !(/^(\/\/|http:|https:).*/.test(url));
            }
            $(function() {
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                            // Send the token to same-origin, relative URLs only.
                            // Send the token only if the method warrants CSRF protection
                            // Using the CSRFToken value acquired earlier
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });
            });
        </script>
        <script type="text/jsx" src="{% static "js/models.js"%}"></script>
        <script type="text/jsx" src="{% static "js/components.js"%}"></script>
        <script type="text/jsx" src="{% static "js/routes.js"%}"></script>
        <script>
            var ROUTER = new Router();
            Backbone.history.start({pushState: true, hashChange: false, root: "/discussion/" + DISCUSSION_ID});



            $('#reply_link').click(function() {
                window.scrollTo(0,document.body.scrollHeight);
                return false;
            });

            $('#go_back').click(function() {
                window.history.back();
                return false;
            });
        </script>
    {% endaddtoblock %}
{% endblock %}